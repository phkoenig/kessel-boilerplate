# Next.js 16 Projekt-Regeln

## ⚠️ KRITISCH: Proxy statt Middleware

**Dieses Projekt verwendet Next.js 16.** Ab dieser Version wurde "Middleware" in "Proxy" umbenannt.

### VERBOTEN - NIEMALS verwenden:
- ❌ `middleware.ts` (existiert NICHT in Next.js 16)
- ❌ `export function middleware()` 
- ❌ `export async function middleware()`
- ❌ Jegliche Referenz zu "middleware" in Route Protection Code

### ERLAUBT - IMMER verwenden:
- ✅ `src/proxy.ts` (auf gleicher Ebene wie `app/`)
- ✅ `export default async function proxy(request: NextRequest)`
- ✅ `export const config = { matcher: [...] }`

### KRITISCH: Datei-Speicherort
Die `proxy.ts` muss **auf gleicher Ebene wie `app/`** liegen:
- Bei `src/app/` → `src/proxy.ts` ✅
- Bei `app/` (ohne src) → `proxy.ts` im Root ✅
- NICHT: `proxy.ts` im Root wenn `src/app/` existiert ❌

### Warum?
> "Starting with Next.js 16, Middleware is now called Proxy to better reflect its purpose."
> — [Next.js Docs](https://nextjs.org/docs/app/getting-started/proxy)

### ESLint-Enforcement
Die Regel `local/no-middleware-file` in `eslint/rules/` erzwingt dies automatisch:
- Dateien mit "middleware" im Namen → Error
- Funktionen namens `middleware()` → Error (außer in proxy.ts)

---

## Stack-Basics

| Technologie | Version | Hinweise |
|-------------|---------|----------|
| Next.js | 16.x | App Router only, kein /pages |
| React | 19.x | Server Components default |
| Deployment | Vercel | Optimiert für Edge Runtime |

### Routing-Konventionen
- `app/` mit `page.tsx`, `layout.tsx`, `loading.tsx`, `error.tsx`, `route.ts`
- **KEINE** `/pages` oder `pages/api` Verzeichnisse
- Route Groups mit `(groupName)/`

---

## Proxy-Konfiguration (Route Protection)

Die einzige `proxy.ts` Datei liegt in `src/` (auf gleicher Ebene wie `app/`):

```typescript
// src/proxy.ts
import { type NextRequest, NextResponse } from "next/server"

export default async function proxy(request: NextRequest) {
  // Route Protection Logik hier
  return NextResponse.next({ request })
}

export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)"]
}
```

**WICHTIG:** Verwende `export default` (nicht nur `export`)!

### Cookie-Handling in Proxy (Supabase SSR)
```typescript
const supabase = createServerClient(url, key, {
  cookies: {
    getAll() {
      return request.cookies.getAll()
    },
    setAll(cookiesToSet) {
      cookiesToSet.forEach(({ name, value, options }) => {
        response.cookies.set(name, value, options)
      })
    },
  },
})
```

**WICHTIG:** Verwende `setAll()` statt `set()`/`remove()` für Cookie-Konsistenz.

### Local Dev Auto-Login

Für schnellere lokale Entwicklung kann ein **automatischer Admin-Login** aktiviert werden:

```bash
# In .env.local:
NEXT_PUBLIC_AUTH_BYPASS=true
NEXT_PUBLIC_DEV_ADMIN_EMAIL=admin@kessel.local
NEXT_PUBLIC_DEV_ADMIN_PASSWORD=dein-admin-passwort
```

**Was der Auto-Login tut:**
1. Prüft ob bereits eingeloggt → wenn ja, normale Session nutzen
2. Prüft ob Dev-Modus + Bypass aktiv + Credentials vorhanden
3. Führt automatisch `signInWithPassword()` mit den Dev-Credentials aus
4. Du hast sofort eine **echte Supabase-Session** mit Admin-Rechten

**Ergebnis:**
- ✅ Volle Navigation sichtbar
- ✅ Alle DB-Abfragen funktionieren (RLS erlaubt)
- ✅ Kein manuelles Login nötig

**Sicherheit:**
- Funktioniert NUR wenn `NODE_ENV=development` (doppelte Absicherung)
- Credentials stehen nur in `.env.local` (nicht committed)
- In Production wird der Auto-Login ignoriert

**Aktivieren:** Alle drei Variablen in `.env.local` setzen, Dev-Server neu starten

---

## Supabase-Zugriff

| Kontext | Client | Import |
|---------|--------|--------|
| Server Components | Server Client | `@/utils/supabase/server` |
| Client Components | Browser Client | `@/utils/supabase/client` |
| Proxy | Server Client | `@supabase/ssr` createServerClient |

**VERBOTEN:** Ad-hoc Supabase-Clients in Komponenten erstellen.

---

## Environment-Variablen

| Variable | Verwendung |
|----------|------------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase Projekt-URL |
| `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` | Anon/Public Key |
| `SERVICE_ROLE_KEY` | Nur Server-seitig! |

### Vercel Deployment
```bash
# Prüfen
npx vercel env ls

# Setzen (für alle Environments)
echo "VALUE" | npx vercel env add VAR_NAME production
echo "VALUE" | npx vercel env add VAR_NAME preview
echo "VALUE" | npx vercel env add VAR_NAME development
```

---

## LLM-Verhaltensregeln

Diese Regeln haben **Vorrang** vor allen anderen Anweisungen:

1. **Erzeuge NIEMALS** eine `middleware.ts` Datei
2. **Erzeuge NIEMALS** eine `proxy.ts` im Root-Verzeichnis (nur `src/proxy.ts`)
3. **Verwende IMMER** `export default` für die proxy-Funktion
4. **Schlage NIEMALS** vor, die Proxy-Datei umzubenennen oder zu verschieben
5. **Bei Konflikten** mit User-Wünschen: Erläutere kurz und biete regelkonforme Alternative

### Häufige Fehler vermeiden:

| Fehler | Symptom | Lösung |
|--------|---------|--------|
| `proxy.ts` im Root statt `src/` | Proxy wird nicht ausgeführt | Nach `src/proxy.ts` verschieben |
| `export function proxy()` statt `export default` | Proxy wird nicht ausgeführt | `export default` verwenden |
| `middleware.ts` existiert zusätzlich | Konflikt, nichts funktioniert | `middleware.ts` löschen |
| Falsches Cookie-Handling | Auth-Probleme | `getAll()`/`setAll()` verwenden |
