---
description: Secrets & Environment Management via Supabase Vault.
globs: ["**/.env*", "**/env.mjs", "**/pull-env.mjs", "**/vercel.json"]
alwaysApply: false
---

# Secrets & Environment

> **NIEMALS Secrets manuell in `.env.local` schreiben!**
> **Ausführliche Doku:** `docs/guides/secrets-management.md`

## Architektur

```
KESSEL Vault (ufqlocxqizmiaozkashi)
        │
        ▼
   pnpm pull-env
        │
        ▼
   .env.local (generiert)
```

## Dateien

| Datei | Inhalt | Git |
|-------|--------|-----|
| `.env` | Bootstrap: SUPABASE_URL + SERVICE_ROLE_KEY | ❌ ignoriert |
| `.env.local` | Alle Secrets (generiert) | ❌ ignoriert |

---

## ⚠️ NEUES SECRET HINZUFÜGEN (COPY-PASTE READY)

### Methode 1: psql (empfohlen)

```bash
# 1. Secret erstellen (WICHTIG: Wert ZUERST, dann Name!)
DB_PASS=$(grep SUPABASE_DB_PASSWORD .env.local | cut -d= -f2) && \
PGPASSWORD="$DB_PASS" psql -h db.ufqlocxqizmiaozkashi.supabase.co -p 5432 -U postgres -d postgres \
  -c "SELECT vault.create_secret('DEIN_SECRET_WERT', 'SECRET_NAME');"

# 2. In .env.local laden
pnpm pull-env

# 3. Verifizieren
grep SECRET_NAME .env.local
```

### Methode 2: REST API (Windows ohne psql)

```bash
# 1. Service Key holen
SERVICE_KEY=$(grep SUPABASE_SERVICE_ROLE_KEY .env.local | cut -d= -f2)

# 2. Secret erstellen
curl -X POST "https://ufqlocxqizmiaozkashi.supabase.co/rest/v1/rpc/insert_secret" \
  -H "apikey: $SERVICE_KEY" \
  -H "Authorization: Bearer $SERVICE_KEY" \
  -H "Content-Type: application/json" \
  -d '{"name": "SECRET_NAME", "secret": "DEIN_SECRET_WERT"}'

# 3. In .env.local laden
pnpm pull-env
```

---

## Secret aktualisieren

```bash
# 1. ID finden
DB_PASS=$(grep SUPABASE_DB_PASSWORD .env.local | cut -d= -f2) && \
PGPASSWORD="$DB_PASS" psql -h db.ufqlocxqizmiaozkashi.supabase.co -p 5432 -U postgres -d postgres \
  -c "SELECT id, name FROM vault.secrets WHERE name = 'SECRET_NAME';"

# 2. Aktualisieren (UUID von oben einsetzen)
DB_PASS=$(grep SUPABASE_DB_PASSWORD .env.local | cut -d= -f2) && \
PGPASSWORD="$DB_PASS" psql -h db.ufqlocxqizmiaozkashi.supabase.co -p 5432 -U postgres -d postgres \
  -c "SELECT vault.update_secret('UUID-HIER'::uuid, 'NEUER_WERT');"

# 3. pnpm pull-env
```

---

## Alle Secrets auflisten

```bash
DB_PASS=$(grep SUPABASE_DB_PASSWORD .env.local | cut -d= -f2) && \
PGPASSWORD="$DB_PASS" psql -h db.ufqlocxqizmiaozkashi.supabase.co -p 5432 -U postgres -d postgres \
  -c "SELECT id, name FROM vault.secrets ORDER BY name;"
```

---

## Regeln

1. **SERVICE_ROLE_KEY nur serverseitig** - Niemals `NEXT_PUBLIC_*`
2. **Keine Fallback-Defaults:** Kein `|| 'dev-key'` im Code
3. **Validierung:** `@t3-oss/env-nextjs` in `src/env.mjs`
4. **Vercel:** `printf` statt `echo` (verhindert Trailing Newlines)

## Vercel: Trailing Newlines vermeiden!

```bash
# ✅ RICHTIG
printf '%s' "WERT" | vercel env add VAR_NAME production

# ❌ FALSCH (fügt \n hinzu!)
echo "WERT" | vercel env add VAR_NAME production
```
