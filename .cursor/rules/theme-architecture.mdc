---
description: CSS-First Theme-Architektur Regeln. Muss bei jeder Theme-bezogenen Änderung angewendet werden.
globs: ["**/themes/**", "**/globals.css", "**/theme-*.tsx", "**/layout.tsx"]
alwaysApply: true
---

# Theme-Architektur Governance

Du arbeitest mit einem CSS-First Theme-System. Dieses System ist für maximale Einfachheit und Boilerplate-Tauglichkeit optimiert.

## 0. next/font Regel (KRITISCH!)

### VERBOTEN auf `<html>` oder `<body>`:
- `fontSans.className`
- `inter.className`
- Jede `.className` Property von next/font

### ERLAUBT auf `<html>`:
- `fontSans.variable`
- `inter.variable`
- Kombinationen: `${fontSans.variable} ${fontMono.variable}`

### Warum?
- `.className` setzt `font-family` direkt mit hoher Spezifität
- Das überschreibt unsere CSS-Token-basierte Steuerung
- `.variable` stellt nur CSS-Variablen bereit (--font-inter, etc.)

### ESLint-Regel
Die Regel `local/no-next-font-classname-on-root` in `eslint/rules/` erzwingt dies automatisch.

---

## 1. Single Source of Truth: Supabase

### Alle Themes in Supabase:
- **CSS:** Supabase Storage Bucket `themes` - `{theme-id}.css`
- **Metadaten:** Supabase Tabelle `public.themes` - id, name, description, dynamic_fonts

### Theme-Provider:
- Lädt alle Themes aus Supabase (via `/api/themes/list`)
- Kein lokaler Fallback mehr - alle Themes sind in Supabase

### VERBOTEN:
- CSS-Variablen in `globals.css` definieren (außer @theme Block)
- Theme-Variablen in JavaScript/TypeScript Dateien
- `root.style.setProperty()` für Theme-Variablen

---

## 2. Neues Theme hinzufügen

### Via Theme Manager UI (einziger Weg)

1. TweakCN CSS exportieren (Tailwind v4)
2. Im Theme Manager (`/themes/manager`) importieren
3. Theme wird automatisch in Supabase gespeichert
4. Fonts werden automatisch validiert und bei Bedarf dynamisch geladen

### Kein lokales Hinzufügen mehr

Es gibt keine lokalen Theme-Dateien mehr (`tokens.css`, `registry.json` wurden entfernt).
Alle Themes werden ausschließlich über die UI und Supabase verwaltet.

---

## 3. Dark Mode Architektur

- `next-themes` setzt `.dark` auf `<html>`
- Unsere Selektoren: `.dark[data-theme="x"]`
- Dark-Variablen werden dynamisch aus Supabase Storage geladen

---

## 4. Theme-Provider Regeln

Der Theme-Provider macht NUR EINS:
```typescript
document.documentElement.setAttribute("data-theme", themeId);
```

### VERBOTEN im Provider:
- `root.style.setProperty("--variable", value)`
- `root.style.fontFamily = ...`
- Jede direkte DOM-Style-Manipulation

### ERLAUBT:
- `setAttribute("data-theme", id)`
- LocalStorage für Persistenz

---

## 5. Radius Underflow-Schutz

In `globals.css` verwenden wir `max()` für sichere Radius-Berechnung:

```css
--radius-sm: max(0px, calc(var(--radius) - 4px));
--radius-md: max(0px, calc(var(--radius) - 2px));
```

Dies verhindert negative Werte bei Themes mit `--radius: 0`.

---

## 6. TweakCN Import Workflow

### Via Theme Manager UI (einziger Weg)
1. Exportiere für "Tailwind v4" in TweakCN
2. Öffne `/themes/manager` in der App
3. Klicke "Theme importieren" und füge CSS ein
4. Theme wird automatisch in Supabase gespeichert

### NIEMALS:
- TweakCN-Export direkt in `globals.css` einfügen
- Lokale Theme-Dateien erstellen (alle Themes in Supabase)

---

## 7. Checkliste für Code-Review

Bei Theme-bezogenen PRs prüfen:

- [ ] Theme in Supabase Storage hochgeladen?
- [ ] Dark Mode in separatem `.dark[data-theme]` Block?
- [ ] Kein `root.style.setProperty()` im Provider?
- [ ] Dynamische Fonts validiert?
- [ ] Radius mit `max(0px, ...)` Schutz in `globals.css`?
